#!/usr/bin/env bash

set -eu -o pipefail

# Pin buildenv container version
BUILDENV_VERSION=0.0.1

# Three supported cross-compilation targets
TARGETS=(
  "linux-amd64"
  "linux-aarch64"
  "windows-amd64"
)

function build_for_target {
  VERSION="$1"; shift
  TARGET="$1"; shift

  echo "Building $VERSION for target: $TARGET" >&2

  # The buildenv entrypoint automatically:
  # 1. Selects the correct toolchain based on BUILD_TARGET
  # 2. Configures with cmake -B /out -G Ninja
  # 3. Builds with cmake --build /out
  # 4. Packages with the package-zip target
  docker run \
    --rm \
    -v "$PWD":/src:ro \
    -v "$PWD"/target/"$TARGET":/out \
    -e TESSERACT_VERSION="$VERSION" \
    -e BUILD_TARGET="$TARGET" \
    ghcr.io/actions-precompiled/buildenv:$BUILDENV_VERSION
}

function build_release {
  VERSION="$1"; shift

  # Build for all three targets
  for target in "${TARGETS[@]}"; do
    build_for_target "$VERSION" "$target"
  done

  # Skip release creation and upload if LOCAL_BUILD is set
  if [[ -v LOCAL_BUILD ]]; then
    echo "LOCAL_BUILD is set, skipping release creation and upload" >&2
    return 0
  fi

  # Create release (idempotent)
  echo "" | gh release create "$VERSION" --target empty || true

  # Upload all three target artifacts
  for target in "${TARGETS[@]}"; do
    if [ -d "./target/$target" ]; then
      gh release upload "$VERSION" --clobber ./target/"$target"/*.zip
    fi
  done
}

# shellcheck disable=SC2206
versions_to_build=($*)

if [ "${#versions_to_build[@]}" -eq 0 ]; then
  gh release list --repo tesseract-ocr/tesseract --json tagName | jq .[].tagName -r > upstream_versions.txt
  gh release list --json tagName | jq '.[].tagName' -r > released_versions.txt

  # shellcheck disable=SC2207
  versions_to_build=($(diff -w upstream_versions.txt released_versions.txt | grep -e '^< ' | sed 's;^< ;;'))
fi

# shellcheck disable=SC2145
echo "Versions to be build: "
for version in "${versions_to_build[@]}"; do
  printf "\tVersion: %s\n" "$version"
done

if [[ -v DRY_RUN ]]; then
  exit 0
fi

for version in "${versions_to_build[@]}"; do
  echo Building version "$version" >&2
  build_release "$version"
done
